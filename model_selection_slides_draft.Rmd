---
title: "EDA"
author: "Tory Norton"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(patchwork)
library(RColorBrewer)
library(lme4)
library(knitr)

#load data
load("particleAdhesion.RData")
adhesion_original <- x
theme_set(theme_classic())
```


# data wrangling

```{r}
# remove constants and redundant cols
adhesion_small <- adhesion_original %>%
  select(-c(bins, removed, hamaker, density, workOfAdhesion))

# move "original" counts to rows with RPM 0
adhesion <- adhesion_small %>%
  group_by(site, sample, avgDiameter, type) %>%
  summarise(retained = unique(original), .groups = "drop") %>%
  mutate(rotation = 0) %>%
  rbind(select(adhesion_small, -original))

adhesion_constants <- adhesion_original %>% 
  group_by(type) %>% 
  summarise(
    density = unique(density),
    hamaker = unique(hamaker),
    workOfAdhesion = unique(workOfAdhesion)
    )

# calculate area for each sample/site
adhesion_area <- adhesion %>%
  # total diameter/area for each size
  mutate(diam = avgDiameter * retained,
         area = (avgDiameter) ^ 2 * pi / 4 * retained) %>%
  group_by(site, sample, rotation, type) %>%
  summarise(
    # sum over sizes
    total_diam = sum(diam),
    total_area = sum(area),
    retained = sum(retained),
    .groups = "drop"
  ) %>%
  mutate(
    # unique identifiers for each (type, sample) and (type, sample, site)
    unique_id = paste0(type, sample, site),
    samp_id = paste0(type, sample),
    # calculate avg diam
    avg_diam = case_when(retained == 0 ~ 0, TRUE ~ total_diam / retained),
    total_area_cm = total_area/1e+4
  ) %>% 
  left_join(adhesion_constants)
```


## Response variable


```{r}
value_labeller <- c(
  "avg_diam" = "'Avg. diameter ('*mu*'m)'",
  "retained" = "'Count'",
  "total_area_cm" = "'Total area (cm'^2*')'"
)
particle_types <- adhesion_area$type %>% unique()

plot_count_diam_area <- function(ptype, legend = F) {
  value_labeller <- c(
    "avg_diam" = "'Avg. diameter ('*mu*'m)'",
    "retained" = "'Count'",
    "total_area_cm" = "'Total area (cm'^2*')'"
  )
  particle_types <- adhesion_area$type %>% unique()
  if (!ptype %in% particle_types) {stop("Invalid type")}
  p <- adhesion_area %>%
    filter(type == ptype) %>%
    mutate(avg_diam = case_match(avg_diam, 0 ~ NA, .default = avg_diam)) %>%
    pivot_longer(cols = c("retained", "avg_diam", "total_area_cm")) %>%
    mutate(name = fct_relevel(name, "retained")) %>%
    ggplot(aes(
      x = rotation,
      y = value,
      color = as.factor(sample)
    )) +
    geom_smooth(se = F, linewidth = 0.7) +
    geom_jitter() +
    facet_wrap(
      ~ name,
      labeller = as_labeller(value_labeller, default = label_parsed),
      ncol = 1,
      scales = "free_y"
    ) +
    scale_color_brewer(type = "qual", palette = 3) +
    labs(title = ptype, color = "Sample", # y = "",
         x = "RPM") +
    theme_classic() +
    theme(
      panel.grid.major = element_line(),
      axis.title.y = element_blank()
    )
  if (!legend) {
    p <- p +
      theme(legend.position = "none")
  }
  return(p)
}

p1 <- plot_count_diam_area("alfalfa")
p2 <- plot_count_diam_area("gypsum", legend = T)

(p1 | p2)
```

- soiling occurs when the surface of the solar panel is obscured by particles, so area is a natural choice of metric to capture "soiling ability"
- we find that some types of particles (e.g., gypsum) tend to break up in the centrifuge, leaving smaller particles behind (i.e., count remains relatively steady while average diameter decreases with rotation speed). Other materials, like alfalfa, are more likely to come off entirely rather than breaking into smaller pieces (average diameter drops slightly while count decreases more rapidly with rotation speed).
  - area has the advantage of capturing both changes
- for each site and rotation speed, we calculate area by aggragating across particle sizes using the midpoint of each diameter bin and the number of particles in each bin

---

```{r}
outlier_ids <- tribble(
  ~unique_id, ~rotation,
  "flyash34", 0,
  "LQ51", 0,
  "graphite13", 0,
  "graphite13", 10000
)

adhesion_outliers <- adhesion_area %>%
  semi_join(outlier_ids)

adhesion_clean <- adhesion_area %>%
  anti_join(outlier_ids)

adhesion_clean %>%
  mutate(outlier = FALSE) %>% 
  rbind(mutate(adhesion_outliers, outlier = TRUE)) %>% 
  filter(type %in% adhesion_outliers$type) %>% 
  mutate(unique_id_rpm = paste0(unique_id,"_", rpm)) %>% 
  ggplot(aes(
    x = rotation,
    y = total_area_cm,
    color = as.factor(sample)
  )) +
  geom_smooth(se = F, linewidth = 0.6, linetype = "solid") +
  geom_jitter(alpha = 0.6) +
  facet_wrap(~ type, scales = "free", nrow = 2) +
  scale_x_continuous(breaks = rpm, labels = rpm / 1000) +
  theme_classic() +
  # theme(legend.position = "right") +
  scale_color_brewer(type = "qual", palette = 3) +
  # geom_point(data = adhesion_outliers) +
  # geom_point(data = adhesion_outliers, shape = 1, color = "red", size = 6, stroke = 1) +
  ggforce::geom_mark_circle(
    mapping = aes(group = unique_id_rpm, filter = outlier),
    color = "red",
  ) +
  scale_y_continuous(expand = expansion(mult = 0.1)) +
  theme(legend.position = c(0.95,0), 
        legend.justification = c(1, 0),
        legend.background = element_rect(color = "black"),
        legend.margin = margin(10, 10, 5, 10, "pt"),
        panel.grid.major  = element_line()) +
  labs(
    color = "Sample",
    x = "RPM (thousands)",
    y = expression("Area (cm" ^ 2 * ")"),
    title = "Outliers"
  ) 
```

- we removed four outlier points (from three sites) with values that seem erroneous
  - e.g., at site 3 for graphite sample 1, the pre-centrifuge counts for nearly all bins are lower than the counts after being spun at 10000rpm. This should not be possible based on the experiment design, so we treat these values as errors and remove them
- those same sites have reasonable values at other rotation speeds, so we leave the other speeds in
  
---

```{r, message=FALSE, warning = F}
rpm <- adhesion_area$rotation %>% 
  unique()

adhesion_area %>%
  # remove outlier for plotting
  filter(type != "flyash" | sample != 3 | rotation != 0 | site != 4) %>%
  ggplot(aes(
    x = rotation,
    y = total_area_cm,
    color = as.factor(sample)
  )) +
  geom_smooth(se = F, linewidth = 0.6) +
  geom_jitter() +
  facet_wrap( ~ type, scales = "free_y") +
  scale_x_continuous(
    breaks = rpm, 
    labels = rpm/1000
  ) +
  theme_classic() +
  labs(
    color = "Sample",
    x = "RPM (thousands)",
    y = expression("Area (cm"^2*")"),
    title = "Particle coverage area after each round of centrifuging"
    ) +
  theme(legend.position = "right") +
  scale_color_brewer(type = "qual", palette = 3) 
  # theme(
  #   legend.position = c(0.95, 0),
  #   legend.justification = c(1, 0),
  #   legend.background = element_rect(color = "black"),
  #   legend.direction = "horizontal",
  #   legend.margin = margin(10, 10, 5, 10, "pt"),
  #   panel.grid.major  = element_line()
  # ) 
```

---

## Physical properties

```{r}
adhesion_constants %>% 
  mutate(hamaker = as.character(signif(hamaker, 3))) %>% 
  relocate(hamaker, .after = last_col()) %>% 
  kable(align = c("lrrr"))
```


```{r}
adhesion_clean %>% 
  filter(rotation == 0) %>% 
  pivot_longer(cols = c(density, workOfAdhesion)) %>% 
  ggplot(aes(x = value, y = total_area_cm, color = type, group = name)) +
  geom_jitter(alpha = 0.6) +
  geom_smooth(method = "lm", se = F) +
  facet_wrap(~name, scales = "free_x") +
  labs(title = "Effect on area before centrifuging")
```

Little evidence that density has a linear effect on particle area before centrifuging, but some evidence for workOfAdhesion. Hence, we include an additive effect for work of adhesion but not density.


```{r}
adhesion_clean %>% 
  # filter(!type %in% c("gypsum", "solosphere")) %>%
  pivot_wider(
    id_cols = c(unique_id, site, sample, type), 
    names_from = rotation, 
    values_from = total_area_cm,
    names_prefix = "rpm_") %>% 
  left_join(adhesion_constants) %>% 
  mutate(area_rm_1000 = rpm_0 - rpm_10000) %>% 
  pivot_longer(cols = c(density, workOfAdhesion)) %>% 
  ggplot(aes(x = value, y = area_rm_1000, color = type, group = name)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = F) +
  facet_wrap(~name, scales = "free_x") +
  labs(title = "all types")

adhesion_clean %>% 
  filter(!type %in% c("gypsum")) %>%
  pivot_wider(
    id_cols = c(unique_id, site, sample, type), 
    names_from = rotation, 
    values_from = total_area_cm,
    names_prefix = "rpm_") %>% 
  left_join(adhesion_constants) %>% 
  mutate(area_rm_1000 = rpm_0 - rpm_1000) %>% 
  pivot_longer(cols = c(density, workOfAdhesion)) %>% 
  ggplot(aes(x = value, y = area_rm_1000, color = type, group = name)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = F) +
  facet_wrap(~name, scales = "free_x") +
  labs(title = "without gypsum")

# adhesion_clean %>% 
#   filter(!type %in% c("gypsum", "solosphere")) %>%
#   pivot_wider(
#     id_cols = c(unique_id, site, sample, type), 
#     names_from = rotation, 
#     values_from = total_area_cm,
#     names_prefix = "rpm_") %>% 
#   left_join(adhesion_constants) %>% 
#   mutate(area_rm_1000 = rpm_0 - rpm_1000) %>% 
#   pivot_longer(cols = c(density, workOfAdhesion)) %>% 
#   ggplot(aes(x = value, y = area_rm_1000, color = type, group = name)) +
#   geom_point() +
#   geom_smooth(method = "lm", se = F) +
#   facet_wrap(~name, scales = "free_x") +
#   labs(title = "without gypsum and solosphere")
```

We use the difference in area at 0prm and 10000rpm to assess evidence for an interaction with rotation speed. At first glance there is moderate evidence that both properties interact with rotation speed, but the effect of work of adhesion appears much weaker if gypsum, which has a number of high outliers, is excluded. Hence, we focused on the interaction between density and rotation speed.

---


# LME model

```{r}
adhesion_clean %>%
  # remove outlier for plotting
  # filter(type != "flyash" | sample != 3 | rotation != 0 | site != 4) %>%
  ggplot(aes(
    x = rotation,
    y = total_area_cm,
    color = as.factor(sample)
  )) +
  geom_smooth(se = F, linewidth = 0.6) +
  geom_jitter() +
  facet_wrap( ~ type, scales = "free_y") +
  scale_x_continuous(
    breaks = rpm, 
    labels = rpm/1000
  ) +
  theme_classic() +
  labs(
    color = "Sample",
    x = "RPM (thousands)",
    y = expression("Area (cm"^2*")"),
    title = "Particle coverage area after each round of centrifuging"
    ) +
  theme(legend.position = "right") +
  scale_color_brewer(type = "qual", palette = 3) 
```

- Modeling approach: We use a random-effects model with a random intercept to account for correlation among measurements from the same slide, and a random slope to allow rates of change to vary by particle type.

- Motivation: Visual inspection shows that measurements from different sites on the same slide tend to cluster at each rotation speed, with some exceptions, e.g., LQ sample 5.
  - Correlation structure: A model with a random intercept at the sample level had lower AIC and BIC than a model with a random intercept at the site-within-sample level, indicating that a sample-level effect is sufficient to account for correlation among measurements.


```{r}
adhesion_scaled <- adhesion_clean %>% 
  mutate(across(where(is.numeric) & !c(site, sample), scale))

# mod_lm <- lm(
#   total_area ~ workOfAdhesion + density*rotation + rotation,
#   data = adhesion_scaled
#   )

# mod_type <- lmer(
#   total_area ~ (1 + rotation|type) + workOfAdhesion + rotation + density*rotation,
#   data = adhesion_scaled
#   )

mod_type_samp <- lmer(
  total_area_cm ~ (1|samp_id) + (rotation|type) + workOfAdhesion + rotation + density*rotation,
  data = adhesion_scaled
  )

mod_type_site <- lmer(
  total_area_cm ~ (1|unique_id) + (rotation|type) + workOfAdhesion + rotation + density*rotation,
  data = adhesion_scaled
  )

mod_list <- list(
  # "mod_lm" = mod_lm,
  # "mod_type" = mod_type,
  "mod_type_samp" = mod_type_samp,
  "mod_type_site" = mod_type_site
)

tibble(
  "Random intercept" = names(mod_list),
  AIC = sapply(mod_list, AIC),
  BIC = sapply(mod_list, BIC)
)
```

The random effects model with intercept based on sample had lower AIC and BIC compared to the model with intercept based on site (within sample). We concluded that a sample effect was sufficient to account for correlation between measurements.


```{r}
plot(mod_site_slope)

re_df_site <- broom.mixed::tidy(mod_site_slope, effects = "ran_vals")

library(lattice)
dotplot(ranef(mod_site_slope, condVar = TRUE),
        strip = FALSE)

ggplot(re_df_site, aes(x = estimate, y = level)) +
  geom_point() +
  facet_wrap(~ term, scales = "free") +
  labs(x = "Random effect estimate",
       y = "Group level") +
  theme_bw()

re_df_type <- broom.mixed::tidy(mod_type_slope, effects = "ran_vals")

ggplot(re_df_type, aes(x = estimate, y = level)) +
  geom_point() +
  facet_wrap(~ term, scales = "free") +
  labs(x = "Random effect estimate",
       y = "Group level") +
  theme_bw()

coef(mod_type_int)
coef(mod_type_slope)
```

We compared AIC and BIC were used 
The linear model without random effects did not physical constants alone were 

```{r}
df_fit <- adhesion_scaled %>% 
  mutate(
  fitted = fitted(mod_type_samp),
  resid = resid(mod_type_samp)
  )

ggplot(df_fit, aes(fitted, total_area_cm)) +
  geom_point(alpha = 0.6) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  labs(x = "Fitted values", y = "Observed values") +
  theme_bw()
  # facet_wrap(~type)

ggplot(df_fit, aes(rotation, resid)) +
  geom_point(alpha = 0.6) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "Rotation speed", y = "Residuals") +
  theme_bw()

ggplot(df_fit, aes(sample = resid)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ type, scales = "free") +
  labs(title = "Qâ€“Q plots of residuals by particle type") +
  theme_bw()

ranef_df <- ranef(mod_type_samp, condVar = TRUE)

dotplot(ranef_df)
```


```{r}
mod_site_slope <- lmer(
  total_area_cm ~ (1|unique_id) + (rotation|type) + woa_scaled + rotation + density_scaled*rotation,
  data = adhesion_clean
  )
```


All predictors/response scaled 

$p$ - particle type
$i$ - sample
$j$ - rotation

$$
\begin{aligned}
y_{pij} &= \beta_0+ \beta_1\text{WOA}_p + \beta_2\text{rpm}_j + \beta_3(\text{rpm}_j\times \text{density}_p) + \mu_{i} + \gamma_i \text{rpm}_j + \epsilon_j \\
\beta_k &\sim N(0, \sigma_\beta^2) \\
\mu_i &\sim N(0, \sigma_\mu^2) \\
\gamma_i &\sim N(0, \sigma_\gamma^2) \\
\sigma_\ell &\sim \text{half-t}(0, 0.01) \qquad \ell \in \{\beta, \mu,\gamma\}\\
\epsilon_j &\sim N(0, \sigma^2) \\
\sigma &\sim \text{half-t}(0, 0.01)
\end{aligned}
$$



